<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –†–ó–°</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --main: #1A237E; --acc: #26D0CE; --bg: #F5F5F7; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 150px; font-size: 16px; color: #333; }
        .header { background: #fff; color: var(--main); padding: 25px; text-align: center; font-weight: 900; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .step { display: none; padding: 20px; }
        .step.active { display: block; }
        .card { background: #fff; border-radius: 20px; padding: 25px; margin-bottom: 15px; border: 2px solid #eee; transition: 0.2s; cursor: pointer; font-weight: 700; }
        .card.selected { border-color: var(--main); background: #f0f2ff; box-shadow: 0 5px 15px rgba(26,35,126,0.1); }
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 2px solid #eee; padding: 20px; z-index: 100; box-shadow: 0 -5px 25px rgba(0,0,0,0.05); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; margin-bottom: 15px; font-weight: 800; color: var(--main); }
        .btn-row { display: flex; gap: 12px; }
        .btn { flex: 1; padding: 20px; border-radius: 18px; border: none; font-weight: 900; font-size: 16px; cursor: pointer; }
        .btn-next { background: var(--main); color: #fff; }
        .btn-back { background: #E0E0E0; color: #666; }
        .date-container { background: #fff; padding: 20px; border-radius: 20px; border: 2px solid #eee; margin-bottom: 15px; }
        input[type="date"], input[type="number"], input[type="text"], input[type="tel"], textarea { 
            width: 100%; padding: 20px; border: 2px solid #eee; border-radius: 15px; box-sizing: border-box; font-size: 17px; margin: 10px 0; background: #fafafa;
        }
        .st-reach { color: var(--acc); font-size: 13px; font-weight: 800; display: block; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="header" id="st_title">–®–ê–ì 1: –†–ê–î–ò–û–°–¢–ê–ù–¶–ò–ò</div>
    
    <div id="steps">
        <div id="step1" class="step active">
            <div class="card" onclick="toggleSt('–ï–í–†–û–ü–ê –ü–õ–Æ–°', this)">–ï–í–†–û–ü–ê –ü–õ–Æ–° <span class="st-reach">81.7–∫ —á–µ–ª/—Å—É—Ç ‚Ä¢ –õ–∏–¥–µ—Ä ‚Ññ1</span></div>
            <div class="card" onclick="toggleSt('–î–û–†–û–ñ–ù–û–ï –†–ê–î–ò–û', this)">–î–û–†–û–ñ–ù–û–ï –†–ê–î–ò–û <span class="st-reach">59.1–∫ —á–µ–ª/—Å—É—Ç ‚Ä¢ 12 –≥–æ—Ä–æ–¥–æ–≤</span></div>
            <div class="card" onclick="toggleSt('–†–ï–¢–†–û FM', this)">–†–ï–¢–†–û FM <span class="st-reach">44.5–∫ —á–µ–ª/—Å—É—Ç ‚Ä¢ –õ–æ—è–ª—å–Ω–æ—Å—Ç—å</span></div>
            <div class="card" onclick="toggleSt('–ö–†–ê–°–ù–ê–Ø –ê–†–ú–ò–Ø', this)">–ö–†–ê–°–ù–ê–Ø –ê–†–ú–ò–Ø <span class="st-reach">30.3–∫ —á–µ–ª/—Å—É—Ç ‚Ä¢ –ö—Ä–µ–∞—Ç–∏–≤</span></div>
            <div class="card" onclick="toggleSt('–ù–û–í–û–ï –†–ê–î–ò–û', this)">–ù–û–í–û–ï –†–ê–î–ò–û <span class="st-reach">14.5–∫ —á–µ–ª/—Å—É—Ç ‚Ä¢ –°—É–ø–µ—Ä—Ö–∏—Ç—ã</span></div>
        </div>

        <div id="step2" class="step">
            <div class="date-container">
                <label style="font-weight:900; color:var(--main)">–î–ê–¢–ê –°–¢–ê–†–¢–ê</label>
                <input type="date" id="start_date" onchange="updDates()">
            </div>
            <div class="date-container">
                <label style="font-weight:900; color:var(--main)">–î–ê–¢–ê –ó–ê–í–ï–†–®–ï–ù–ò–Ø</label>
                <input type="date" id="end_date" onchange="updDates()">
            </div>
            <div id="days_display" style="text-align:center; padding:20px; font-weight:900; color:var(--main); font-size:22px;">–í–´–ë–†–ê–ù–û: 0 –î–ù–ï–ô</div>
        </div>

        <div id="step3" class="step">
            <button class="btn btn-next" onclick="selAllSlots()" style="margin-bottom:20px; background:#FFA000; color:#fff">–í–´–ë–†–ê–¢–¨ –í–°–ï 15 –°–õ–û–¢–û–í</button>
            <div id="slots_container"></div>
        </div>

        <div id="step4" class="step">
            <h3 style="text-align:center; color:var(--main); margin-bottom:30px;">–í–ê–†–ò–ê–ù–¢ –†–û–õ–ò–ö–ê</h3>
            <div class="card" onclick="setPath('text')">–£ –ú–ï–ù–Ø –ï–°–¢–¨ –¢–ï–ö–°–¢ (–ù–£–ñ–ù–ê –û–ó–í–£–ß–ö–ê)</div>
            <div class="card" onclick="setPath('audio')">–£ –ú–ï–ù–Ø –ï–°–¢–¨ –ì–û–¢–û–í–´–ô –§–ê–ô–õ</div>
        </div>

        <div id="step5" class="step">
            <h3 style="color:var(--main); margin-bottom:10px;">–•–†–û–ù–û–ú–ï–¢–†–ê–ñ –†–û–õ–ò–ö–ê</h3>
            <input type="number" id="duration" value="20" min="5" max="30" oninput="upd()">
            <p style="color:#999; font-size:14px; line-height:1.4;">–£–∫–∞–∂–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö. –ë—é–¥–∂–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
        </div>

        <div id="step6" class="step">
            <h3 style="color:var(--main); margin-bottom:10px;">–¢–ï–ö–°–¢ –î–õ–Ø –û–ó–í–£–ß–ö–ò</h3>
            <textarea id="campaign_text" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
            <p style="color:#999; font-size:13px;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –¥–æ 40 —Å–ª–æ–≤ –¥–ª—è —Ä–æ–ª–∏–∫–∞ 20 —Å–µ–∫—É–Ω–¥.</p>
        </div>

        <div id="step7" class="step">
            <div class="card" onclick="setProd('standard', this)">–ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ô ‚Äî 5 000 ‚ÇΩ <br><span style="font-size:12px; color:#999; font-weight:normal">–î–∏–∫—Ç–æ—Ä, –º—É–∑—ã–∫–∞, –º–æ–Ω—Ç–∞–∂. –°—Ä–æ–∫ 3 –¥–Ω—è.</span></div>
            <div class="card" onclick="setProd('premium', this)">–í–û–ö–ê–õ–¨–ù–´–ô ‚Äî 12 500 ‚ÇΩ <br><span style="font-size:12px; color:#999; font-weight:normal">–ò–≥—Ä–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–æ–∫–∞–ª.</span></div>
            <p style="font-size:11px; color:#999; text-align:center; padding:10px">* –¶–µ–Ω–∞ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–∏–∫—Ç–æ—Ä–∞</p>
        </div>

        <div id="step8" class="step">
            <h3 style="color:var(--main); margin-bottom:20px;">–ö–û–ù–¢–ê–ö–¢–ù–´–ï –î–ê–ù–ù–´–ï</h3>
            <input type="text" id="contact_name" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="text" id="company" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
            <input type="tel" id="phone" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω">
        </div>
    </div>

    <div class="footer-nav">
        <div class="stat-grid" id="footer_stats" style="display:none;">
            <div>–ë—é–¥–∂–µ—Ç: <span id="f_price">...</span></div>
            <div>–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤: <span id="f_ots">...</span></div>
            <div>–í—ã—Ö–æ–¥–æ–≤/–¥–µ–Ω—å: <span id="f_slots">0</span></div>
            <div>–û—Ö–≤–∞—Ç: <span id="f_rc">...</span></div>
        </div>
        <div id="step_info" style="font-weight:900; color:var(--main); margin-bottom:15px; text-align:center; font-size:14px;">
            –í–´–ë–†–ê–ù–û –°–¢–ê–ù–¶–ò–ô: <span id="st_count">0</span>
        </div>
        <div class="btn-row">
            <button id="back_btn" class="btn btn-back" onclick="move(-1)" style="display:none;">–ù–ê–ó–ê–î</button>
            <button id="home_btn" class="btn btn-back" onclick="location.href='index.html'">–ì–õ–ê–í–ù–ê–Ø</button>
            <button id="next_btn" class="btn btn-next" onclick="move(1)">–î–ê–õ–ï–ï</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let step = 1, radios = [], slots = [], path = '', prod = 'none', days = 0;
        let lastCalc = { final_price: 0, ots: 0, total_reach: 0 };
        
        function haptic() { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }

        function upd() {
            let dur = document.getElementById('duration').value;
            let data = { selected_radios: radios, selected_time_slots: slots, campaign_days: days, duration: dur, production_option: prod };
            fetch('/api/calculate', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) })
            .then(r => r.json()).then(d => {
                lastCalc = d.calculation;
                document.getElementById('f_price').innerText = d.calculation.final_price.toLocaleString() + ' ‚ÇΩ';
                document.getElementById('f_ots').innerText = d.calculation.ots.toLocaleString();
                document.getElementById('f_rc').innerText = d.calculation.total_reach.toLocaleString() + ' —á–µ–ª.';
                document.getElementById('f_slots').innerText = slots.length * radios.length;
            });
        }

        function toggleSt(name, el) {
            haptic(); let i = radios.indexOf(name);
            if(i > -1) radios.splice(i,1); else radios.push(name);
            el.classList.toggle('selected');
            document.getElementById('st_count').innerText = radios.length;
        }

        function updDates() {
            let s = new Date(document.getElementById('start_date').value);
            let e = new Date(document.getElementById('end_date').value);
            if(s && e && e >= s) {
                days = Math.ceil((e - s) / (1000*60*60*24)) + 1;
                document.getElementById('days_display').innerText = `–ò–¢–û–ì–û: ${days} –î–ù–ï–ô`;
            }
        }

        function loadSlots() {
            const labels = ["06:00 –ü–æ–¥—ä–µ–º","07:00 –¢—Ä–∞—Ñ–∏–∫ üöÄ","08:00 –ü–∏–∫ üöÄ","09:00 –†–∞–±–æ—Ç–∞ üöÄ","10:00 –†–∞–±–æ—Ç–∞","11:00 –û—Ñ–∏—Å","12:00 –û–±–µ–¥","13:00 –û–±–µ–¥","14:00 –î–µ–Ω—å","15:00 –î–µ–Ω—å","16:00 –ö–æ–Ω–µ—Ü –¥–Ω—è","17:00 –í–µ—á–µ—Ä üöÄ","18:00 –ü–∏–∫ üöÄ","19:00 –î–æ–º","20:00 –û—Ç–¥—ã—Ö"];
            let html = '';
            labels.forEach((l, i) => {
                let sel = slots.includes(i) ? 'selected' : '';
                html += `<div class="card ${sel}" onclick="toggleSlot(${i}, this)" style="padding:15px; margin-bottom:8px; font-size:14px">${l}</div>`;
            });
            document.getElementById('slots_container').innerHTML = html;
        }

        function toggleSlot(i, el) { haptic(); let idx = slots.indexOf(i); if(idx > -1) slots.splice(idx,1); else slots.push(i); el.classList.toggle('selected'); }

        function selAllSlots() { slots = Array.from({length:15},(_,i)=>i); loadSlots(); }
        function setPath(p) { haptic(); path = p; move(1); }
        function setProd(p, el) { 
            haptic(); prod = p; 
            document.querySelectorAll('#step7 .card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected'); upd(); move(1); 
        }

        function move(dir) {
            haptic();
            if(step === 1 && radios.length === 0 && dir > 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–¥–∏–æ!');
            if(step === 8 && dir > 0) return submit();

            document.getElementById('step'+step).classList.remove('active');
            if(step === 4 && dir > 0) step = (path === 'text') ? 6 : 5;
            else if (step === 5 && dir > 0) { step = 8; upd(); }
            else if (step === 6 && dir > 0) step = 7;
            else if (step === 7 && dir < 0) step = 6;
            else if (step === 8 && dir < 0) step = (path === 'text') ? 7 : 5;
            else step += dir;

            document.getElementById('step'+step).classList.add('active');
            document.getElementById('back_btn').style.display = (step > 1) ? 'block' : 'none';
            document.getElementById('home_btn').style.display = (step === 1) ? 'block' : 'none';
            document.getElementById('next_btn').innerText = step === 8 ? '–û–¢–ü–†–ê–í–ò–¢–¨' : '–î–ê–õ–ï–ï';
            document.getElementById('st_title').innerText = "–®–ê–ì " + step;
            
            document.getElementById('footer_stats').style.display = (step >= 5 && step < 8) ? 'grid' : 'none';
            document.getElementById('step_info').style.display = (step < 5) ? 'block' : 'none';
            
            if(step === 3) loadSlots();
            window.scrollTo(0,0);
        }

        function submit() {
            let data = {
                user_id: tg.initDataUnsafe?.user?.id || 123,
                selected_radios: radios, selected_time_slots: slots,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                campaign_days: days, duration: document.getElementById('duration').value,
                campaign_text: document.getElementById('campaign_text').value,
                production_option: prod,
                contact_name: document.getElementById('contact_name').value,
                company: document.getElementById('company').value,
                phone: document.getElementById('phone').value,
                final_price: lastCalc.final_price, total_reach: lastCalc.total_reach, ots: lastCalc.ots
            };
            fetch('/api/create-campaign', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) })
            .then(r => r.json()).then(d => { if(d.success) location.href='/confirmation.html?campaign='+d.campaign_number; });
        }
        window.onload = () => { tg.expand(); };
    </script>
</body>
</html>
