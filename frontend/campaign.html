<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Калькулятор РЗС</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --main: #1A237E; --accent: #26D0CE; --bg: #F4F6F9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; }
        .header { background: var(--main); color: #fff; padding: 20px; text-align: center; font-weight: bold; }
        .step { display: none; padding: 15px; }
        .step.active { display: block; }
        .card { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 2px solid #eee; transition: 0.2s; cursor: pointer; }
        .card.selected { border-color: var(--main); background: #E8EAF6; }
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 2px solid var(--main); padding: 15px; z-index: 100; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; margin-bottom: 10px; font-weight: 600; color: #555; }
        .btn-row { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-next { background: var(--main); color: #fff; }
        .btn-back { background: #9E9E9E; color: #fff; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .st-reach { color: var(--accent); font-size: 12px; font-weight: 800; }
    </style>
</head>
<body>
    <div class="header" id="step_title">ШАГ 1: РАДИОСТАНЦИИ</div>
    
    <div id="steps">
        <div id="step1" class="step active">
            <div class="card" onclick="toggleSt('ЕВРОПА ПЛЮС', this)">ЕВРОПА ПЛЮС <br><span class="st-reach">81.7к чел/сут</span></div>
            <div class="card" onclick="toggleSt('ДОРОЖНОЕ РАДИО', this)">ДОРОЖНОЕ РАДИО <br><span class="st-reach">59.1к чел/сут</span></div>
            <div class="card" onclick="toggleSt('РЕТРО FM', this)">РЕТРО FM <br><span class="st-reach">44.5к чел/сут</span></div>
            <div class="card" onclick="toggleSt('КРАСНАЯ АРМИЯ', this)">КРАСНАЯ АРМИЯ <br><span class="st-reach">30.3к чел/сут</span></div>
            <div class="card" onclick="toggleSt('НОВОЕ РАДИО', this)">НОВОЕ РАДИО <br><span class="st-reach">14.5к чел/сут</span></div>
        </div>

        <div id="step2" class="step">
            <label>Дата начала:</label><input type="date" id="start_date" onchange="updDates()">
            <label style="margin-top:10px; display:block;">Дата окончания:</label><input type="date" id="end_date" onchange="updDates()">
            <label style="margin-top:10px; display:block;">Хронометраж (сек):</label>
            <input type="number" id="duration" value="20" min="5" max="30" onchange="upd()">
        </div>

        <div id="step3" class="step">
            <button class="btn btn-next" onclick="selAllSlots()" style="margin-bottom:10px; background:#FFA000">ВЫБРАТЬ ВСЕ 15 СЛОТОВ</button>
            <div id="slots_container"></div>
        </div>

        <div id="step4" class="step">
            <div class="card" onclick="setPath('text')">У МЕНЯ ЕСТЬ ТЕКСТ (НУЖЕН РОЛИК)</div>
            <div class="card" onclick="setPath('audio')">У МЕНЯ ЕСТЬ ГОТОВЫЙ РОЛИК</div>
        </div>

        <div id="step5" class="step">
            <textarea id="campaign_text" rows="6" placeholder="Введите текст ролика..." oninput="saveTxt()"></textarea>
            <p id="speed" style="font-size:12px; margin-top:5px;"></p>
        </div>

        <div id="step7" class="step">
            <div class="card" onclick="setProd('standard', this)">СТАНДАРТНЫЙ (+2000р)</div>
            <div class="card" onclick="setProd('premium', this)">ПРЕМИУМ (+5000р)</div>
        </div>

        <div id="step8" class="step">
            <input type="text" id="contact_name" placeholder="Ваше имя">
            <input type="text" id="company" placeholder="Компания" style="margin-top:10px;">
            <input type="tel" id="phone" placeholder="Телефон" style="margin-top:10px;">
            <input type="email" id="email" placeholder="Email" style="margin-top:10px;">
        </div>
    </div>

    <div class="footer-nav">
        <div class="stat-grid">
            <div>Бюджет: <span id="f_price">0 ₽</span></div>
            <div>Контактов: <span id="f_ots">0</span></div>
            <div>Охват/сут: <span id="f_rd">0</span></div>
            <div>Охват/период: <span id="f_rc">0</span></div>
        </div>
        <div class="btn-row">
            <button id="back_btn" class="btn btn-back" onclick="move(-1)" style="display:none;">НАЗАД</button>
            <button id="next_btn" class="btn btn-next" onclick="move(1)">ДАЛЕЕ</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let step = 1, radios = [], slots = [], path = '', prod = 'none', days = 0;
        
        function haptic() { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }

        function upd() {
            let data = {
                selected_radios: radios, selected_time_slots: slots,
                campaign_days: days, duration: document.getElementById('duration').value,
                production_option: prod
            };
            fetch('/api/calculate', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) })
            .then(r => r.json()).then(d => {
                document.getElementById('f_price').innerText = d.calculation.final_price.toLocaleString() + ' ₽';
                document.getElementById('f_ots').innerText = d.calculation.ots.toLocaleString();
                document.getElementById('f_rd').innerText = d.calculation.daily_coverage.toLocaleString();
                document.getElementById('f_rc').innerText = d.calculation.total_reach.toLocaleString();
            });
        }

        function toggleSt(name, el) {
            haptic();
            let i = radios.indexOf(name);
            if(i > -1) radios.splice(i,1); else radios.push(name);
            el.classList.toggle('selected'); upd();
        }

        function updDates() {
            let s = new Date(document.getElementById('start_date').value);
            let e = new Date(document.getElementById('end_date').value);
            if(s && e && e >= s) {
                days = Math.ceil((e - s) / (1000*60*60*24)) + 1;
                upd();
            }
        }

        function loadSlots() {
            let html = '';
            for(let i=0; i<15; i++) {
                let sel = slots.includes(i) ? 'selected' : '';
                html += `<div class="card ${sel}" onclick="toggleSlot(${i}, this)">Слот ${i+6}:00 - ${i+7}:00</div>`;
            }
            document.getElementById('slots_container').innerHTML = html;
        }

        function toggleSlot(i, el) {
            haptic();
            let idx = slots.indexOf(i);
            if(idx > -1) slots.splice(idx,1); else slots.push(i);
            el.classList.toggle('selected'); upd();
        }

        function selAllSlots() { slots = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]; loadSlots(); upd(); }
        function setPath(p) { haptic(); path = p; move(1); }
        function saveTxt() {
            let t = document.getElementById('campaign_text').value;
            localStorage.setItem('rzs_saved_text', t);
            document.getElementById('speed').innerText = t.length > 150 ? "⚠️ Слишком длинный текст" : "✅ Оптимально";
        }
        function setProd(p, el) { 
            haptic(); prod = p; 
            document.querySelectorAll('#step7 .card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected'); upd(); 
        }

        function move(dir) {
            haptic();
            if(step === 1 && radios.length === 0 && dir > 0) return alert('Выберите радиостанции!');
            if(step === 8 && dir > 0) return submit();

            document.getElementById('step'+step).classList.remove('active');
            if(step === 4 && dir > 0) step = (path === 'text') ? 5 : 8;
            else if (step === 5 && dir > 0) step = 7;
            else if (step === 7 && dir < 0) step = 5;
            else if (step === 8 && dir < 0) step = (path === 'text') ? 7 : 4;
            else step += dir;

            document.getElementById('step'+step).classList.add('active');
            document.getElementById('back_btn').style.display = step > 1 ? 'block' : 'none';
            document.getElementById('next_btn').innerText = step === 8 ? 'ОТПРАВИТЬ' : 'ДАЛЕЕ';
            document.getElementById('step_title').innerText = "ШАГ " + step;
            if(step === 3) loadSlots();
            window.scrollTo(0,0);
        }

        function submit() {
            let data = {
                user_id: tg.initDataUnsafe?.user?.id || 123,
                selected_radios: radios, selected_time_slots: slots,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                campaign_days: days, duration: document.getElementById('duration').value,
                campaign_text: document.getElementById('campaign_text').value,
                production_option: prod,
                contact_name: document.getElementById('contact_name').value,
                company: document.getElementById('company').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                final_price: document.getElementById('f_price').innerText.replace(/\D/g,''),
                total_reach: document.getElementById('f_rc').innerText.replace(/\D/g,''),
                ots: document.getElementById('f_ots').innerText.replace(/\D/g,'')
            };
            fetch('/api/create-campaign', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) })
            .then(r => r.json()).then(d => { if(d.success) location.href='/confirmation.html?campaign='+d.campaign_number; });
        }

        window.onload = () => { 
            tg.expand(); 
            let saved = localStorage.getItem('rzs_saved_text');
            if(saved) document.getElementById('campaign_text').value = saved;
        };
    </script>
</body>
</html>
